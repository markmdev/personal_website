---
 const STORAGE_KEY = "cookie-consent:v1";
---

<style>
  .cookie-banner {
    position: fixed; left: 50%; bottom: 16px; transform: translateX(-50%);
    max-width: 720px; width: calc(100% - 32px);
    background: #0a0d10; color: #e6f5ec;
    border: 1px solid #2a3439; border-radius: 12px;
    padding: .9rem 1rem; z-index: 9999;
    box-shadow: 0 10px 24px rgba(0,0,0,.35);
    display: none;
  }
  .cookie-banner__row {
  display: flex;
  flex-direction: column;  
  align-items: flex-start; 
  gap: .75rem;
}

.cookie-banner__actions {
  display: flex;
  gap: .75rem;
}

  .cookie-banner__text { flex: 1; line-height: 1.35; font-size: .95rem; }
  .cookie-banner__btn {
    appearance: none; border: 1px solid #2a3439; background: transparent;
    color: #e6f5ec; padding: .5rem .8rem; border-radius: 9px; font-weight: 600;
    cursor: pointer; white-space: nowrap;
  }
  .cookie-banner__btn--primary { background: #7ad0a6; color: #0a0d10; }
  .cookie-banner a { color: #a7e7c8; text-decoration: underline; }
  @media (prefers-reduced-motion:no-preference){
    .cookie-banner { animation: slideup .22s ease-out; }
    @keyframes slideup { from { transform: translate(-50%, 12px); opacity:.8 } to { transform: translate(-50%,0); opacity:1 } }
  }
</style>

<div id="cookie-banner" class="cookie-banner font-sans" role="region" aria-label="Cookies">
    <div class="cookie-banner__row">
        <div class="cookie-banner__text">
          We use cookies for <strong>analytics</strong> only. Ads & personalization are off by default.
          Choose <em>Accept</em> to enable analytics, or <em>Reject</em> to continue with essentials.
          <a href="/privacy">Privacy Policy</a>
        </div>
        <div class="cookie-banner__actions">
          <button id="cookie-reject" class="cookie-banner__btn">Reject</button>
          <button id="cookie-accept" class="cookie-banner__btn cookie-banner__btn--primary">Accept</button>
        </div>
      </div>
      
</div>

<script is:inline>
  (function () {
    const KEY = "cookie-consent:v1";
    const el = document.getElementById("cookie-banner");
    const btnAccept = document.getElementById("cookie-accept");
    const btnReject = document.getElementById("cookie-reject");

    const getChoice = () => localStorage.getItem(KEY);
    const setChoice = (v) => localStorage.setItem(KEY, v);

    function updateConsent(granted) {
      const state = granted ? "granted" : "denied";
      const call = () => {
        if (typeof window.gtag !== "function") return false;
        window.gtag("consent", "update", {
          ad_storage: "denied",
          ad_user_data: "denied",
          ad_personalization: "denied",
          analytics_storage: state,
          functionality_storage: "granted",
          security_storage: "granted",
        });
        return true;
      };
      if (!call()) {
        let tries = 0;
        const t = setInterval(() => {
          tries++;
          if (call() || tries > 40) clearInterval(t); // ~10s max
        }, 250);
      }
    }

    function showIfNeeded() {
      if (!getChoice()) el.style.display = "block";
    }

    btnAccept?.addEventListener("click", () => {
      setChoice("accept");
      updateConsent(true);
      el.style.display = "none";
    });

    btnReject?.addEventListener("click", () => {
      setChoice("reject");
      updateConsent(false);
      el.style.display = "none";
    });

    window.showCookieBanner = function () {
      el.style.display = "block";
    };

    showIfNeeded();
  })();
</script>
